apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: tepslab
data:
  backup.sh: |
    #!/bin/bash
    set -e

    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_NAME="tepslab-backup-${TIMESTAMP}"
    BACKUP_DIR="/backups/${BACKUP_NAME}"

    echo "[INFO] Creating backup directory: $BACKUP_DIR"
    mkdir -p "$BACKUP_DIR"

    # Backup MongoDB
    echo "[INFO] Backing up MongoDB..."
    MONGO_POD=$(kubectl get pods -n tepslab -l app=mongodb -o jsonpath='{.items[0].metadata.name}')
    kubectl exec -n tepslab $MONGO_POD -- mongodump --out=/tmp/mongodb-backup --gzip
    kubectl cp -n tepslab $MONGO_POD:/tmp/mongodb-backup "$BACKUP_DIR/mongodb"
    kubectl exec -n tepslab $MONGO_POD -- rm -rf /tmp/mongodb-backup

    # Backup Redis
    echo "[INFO] Backing up Redis..."
    REDIS_POD=$(kubectl get pods -n tepslab -l app=redis -o jsonpath='{.items[0].metadata.name}')
    kubectl exec -n tepslab $REDIS_POD -- redis-cli BGSAVE
    sleep 5
    kubectl cp -n tepslab $REDIS_POD:/data/dump.rdb "$BACKUP_DIR/redis-dump.rdb"

    # Backup Uploads
    echo "[INFO] Backing up uploads..."
    SERVER_POD=$(kubectl get pods -n tepslab -l app=server -o jsonpath='{.items[0].metadata.name}')
    kubectl exec -n tepslab $SERVER_POD -- tar -czf /tmp/uploads.tar.gz -C /app uploads
    kubectl cp -n tepslab $SERVER_POD:/tmp/uploads.tar.gz "$BACKUP_DIR/uploads.tar.gz"
    kubectl exec -n tepslab $SERVER_POD -- rm -f /tmp/uploads.tar.gz

    # Create metadata
    cat > "$BACKUP_DIR/metadata.json" <<EOF
    {
      "backup_name": "${BACKUP_NAME}",
      "timestamp": "${TIMESTAMP}",
      "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
    }
    EOF

    # Compress
    echo "[INFO] Compressing backup..."
    cd /backups
    tar -czf "${BACKUP_NAME}.tar.gz" "${BACKUP_NAME}"
    rm -rf "${BACKUP_NAME}"

    # Upload to S3 if configured
    if [ -n "$S3_BUCKET" ]; then
      echo "[INFO] Uploading to S3..."
      aws s3 cp "/backups/${BACKUP_NAME}.tar.gz" "s3://${S3_BUCKET}/backups/${BACKUP_NAME}.tar.gz"
    fi

    # Cleanup old backups
    echo "[INFO] Cleaning up old backups..."
    find /backups -name "tepslab-backup-*.tar.gz" -mtime +30 -delete

    echo "[INFO] Backup completed: ${BACKUP_NAME}.tar.gz"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: tepslab-backup
  namespace: tepslab
spec:
  # Run every day at 2 AM
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: backup
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - /scripts/backup.sh
            env:
            - name: S3_BUCKET
              valueFrom:
                configMapKeyRef:
                  name: backup-config
                  key: s3_bucket
                  optional: true
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: backup-secrets
                  key: aws_access_key_id
                  optional: true
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: backup-secrets
                  key: aws_secret_access_key
                  optional: true
            - name: AWS_DEFAULT_REGION
              valueFrom:
                configMapKeyRef:
                  name: backup-config
                  key: aws_region
                  optional: true
            volumeMounts:
            - name: backup-script
              mountPath: /scripts
            - name: backups
              mountPath: /backups
          volumes:
          - name: backup-script
            configMap:
              name: backup-script
              defaultMode: 0755
          - name: backups
            persistentVolumeClaim:
              claimName: backups-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backups-pvc
  namespace: tepslab
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: standard

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-sa
  namespace: tepslab

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: backup-role
  namespace: tepslab
rules:
- apiGroups: [""]
  resources: ["pods", "pods/exec"]
  verbs: ["get", "list", "create"]
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: backup-rolebinding
  namespace: tepslab
subjects:
- kind: ServiceAccount
  name: backup-sa
  namespace: tepslab
roleRef:
  kind: Role
  name: backup-role
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-config
  namespace: tepslab
data:
  s3_bucket: ""  # Set your S3 bucket name
  aws_region: "us-east-1"

---
apiVersion: v1
kind: Secret
metadata:
  name: backup-secrets
  namespace: tepslab
type: Opaque
stringData:
  aws_access_key_id: ""  # Set your AWS credentials
  aws_secret_access_key: ""
